#encoding:utf-8
import tornado.ioloop
import tornado.web
import tornado.httpserver
import tornado.options
import hashlib
from lxml import etree
import time
import urllib
import urllib2
import json

from tornado.options import define, options
define("port", default=80, help="run on the given port", type=int)

class MainHandler(tornado.web.RequestHandler):
    def get(self):
        # 获取输入参数
        signature = self.get_argument('signature')
        timestamp = self.get_argument('timestamp')
        nonce = self.get_argument('nonce')
        echostr = self.get_argument('echostr')
        # 自己的token
        token = "matthewzheng"  # 这里改写你在微信公众平台里输入的token
        # 字典序排序
        list = [token, timestamp, nonce]
        list.sort()
        sha1 = hashlib.sha1()
        map(sha1.update, list)
        hashcode = sha1.hexdigest()
        # sha1加密算法
        # 如果是来自微信的请求，则回复echostr
        if hashcode == signature:
            self.write(echostr)
	
    def post(self):
        str_xml = self.request.body  # 获得post来的数据
        xml = etree.fromstring(str_xml)  # 进行XML解析
        content = xml.find("Content").text  # 获得用户所输入的内容
        msgType = xml.find("MsgType").text
        fromUser = xml.find("FromUserName").text
        toUser = xml.find("ToUserName").text

        res = searchMusic(content)
        content_json = json.load(res)
        songs = content_json['result']['songs']
        if len(songs) == 0:
            return self.render('reply_text.xml', toUser = fromUser,  fromUser = toUser, createTime = int(time.time()), content = u"找不到你需要的音乐:" + content)
        song = songs[0]
        music_title = song['bMusic']['name']
        music_url = song['mp3Url']
        return self.render('reply_music.xml', toUser = fromUser,  fromUser = toUser, createTime = int(time.time()), TITLE = music_title, MUSIC_Url = music_url, HQ_MUSIC_Url = music_url)

application = tornado.web.Application([
    (r"/weixin", MainHandler),
])

if __name__ == "__main__":
    tornado.options.parse_command_line()
    httpserver = tornado.httpserver.HTTPServer(application)
    httpserver.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()

def searchMusic(text):
    data = {'s':text,'offset':0,'limit':1, 'type':1}
    body = urllib.urlencode(data)
    header = {'Cookie':'appver=1.5.0.75771','Referer':'http://music.163.com/'}
    url = 'http://music.163.com/api/search/pc'
    req = urllib2.Request(url=url,data=body,headers=header)
    res_data = urllib2.urlopen(req)
    res = res_data.read()
    return res
